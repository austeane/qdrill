## Shared Practice Plan Components & Drag Manager Review

This section reviews components and stores shared between the main Practice Plan form/editor and potentially the wizard or viewer.

**Files Reviewed:**

*   `src/lib/stores/dragManager.js`:
    *   **Notes:** Orchestrates all drag-and-drop operations for sections, groups (parallel blocks), and individual items (drills/breaks). Manages a central `dragState` store holding information about the source, target, type of drag, and drop position. Uses a combination of indices, item/group IDs, generated element IDs (used as classes), and data attributes (`data-*`) to track elements. Directly interacts with `sectionsStore` to modify the sections array upon a successful `handleDrop` and uses `historyStore` (`addToHistory`) to record changes. Implements visual feedback by adding/removing CSS classes (`dragging`, `drop-before`, `drop-after`, etc.). Includes helper functions for calculating drop position and finding source items using multiple strategies (ID, name, index). Contains significant debugging (`logger.debug`) and some recovery logic (e.g., reading data from `event.dataTransfer` or `dataset` if state seems inconsistent).
    *   **Potential Issues:**
        *   **High Complexity:** The logic, especially within `handleDrop` and its sub-handlers (`handleItemDrop`, `handleGroupDrop`, `handleSectionDrop`, `handleTimelineDrop`, `handleSameTimelineReordering`), is extremely complex due to the variety of drag types, drop targets (item, group, section, timeline, empty area), and the need to handle nested structures (items within sections, items within timelines within groups). This makes it hard to follow and prone to bugs.
        *   **Fragile Tracking:** Relies on a mix of identifiers (sectionIndex, itemIndex, timelineItemIndex, itemId, groupId, data attributes). While attempts are made to use stable IDs (`itemId`), indices are still heavily used. If the underlying `sections` array changes unexpectedly during a drag (perhaps due to a race condition or external update), using indices could lead to incorrect operations. The `findSourceItem` function attempts to mitigate this with fallbacks, but it adds complexity.
        *   **Tight Coupling to `sectionsStore`:** Directly imports and modifies the `sections` writable store from `sectionsStore`. This makes `dragManager` unusable with any other state management approach (like the wizard's `wizardStore.sections`) without significant refactoring. It also assumes the structure of the objects within `sectionsStore`.
        *   **DOM Dependency/Manipulation:** Relies on `getBoundingClientRect` for drop position calculations and directly manipulates CSS classes on DOM elements for visual feedback. While standard for drag/drop, it adds coupling to specific DOM structures and class names. The `multiPhaseCleanup` function suggests potential issues with reliably removing indicator classes.
        *   **`window.__dragManager` Usage:** The store exposes its state via `window.__dragManager`. While useful for debugging, its use within `TimelineColumn.svelte`'s drop handler to *force-update* the state before calling the main `handleDrop` is a major code smell, suggesting potential state synchronization issues or flaws in the core drop logic.
        *   **Debugging Noise:** Extensive `console.log`/`logger.debug` calls remain, indicating the complexity and potential difficulty in debugging this system.
*   `src/components/practice-plan/sections/SectionContainer.svelte`:
    *   **Notes:** Renders a single practice plan section, including its header (`SectionHeader`) and items. Handles rendering of both individual items (`DrillItem`) and parallel groups (`ParallelGroup`) by iterating through `section.items`. Manages drag-and-drop for the *entire section* itself (making the section draggable and a drop target for other sections). Also acts as a drop target for items dragged into an empty section.
    *   **Store Interaction:** Imports and uses multiple drag handlers from `dragManager`. Imports `removeSection` and `removeItem` directly from `sectionsStore`. `removeSection` is passed to `SectionHeader`, while `removeItem` logic is implicitly passed down to `DrillItem`.
    *   **Wizard Compatibility:** **Problematic.** While it receives the `section` object via props (making rendering potentially compatible if the wizard's section structure matches), the direct import and use of `removeSection` and `removeItem` from `sectionsStore` prevents straightforward use with `wizardStore`. The wizard would need to intercept these actions or the component needs refactoring to accept removal callbacks as props.
*   `src/components/practice-plan/items/DrillItem.svelte`:
    *   **Notes:** Renders a single non-parallel item (drill or break). Handles drag start for the item, passing necessary identifiers (indices, item ID, timeline info) to `dragManager.startItemDrag`. Acts as a drop target for other items (`handleItemDragOver`). Includes functionality to change the item's duration and remove the item. Makes extensive use of `data-*` attributes to store identifiers, likely for recovery/consistency within `dragManager`.
    *   **Store Interaction:** Imports and uses drag handlers from `dragManager`. Imports and calls `handleDurationChange` directly from `sectionsStore`. Calls `onRemove` prop for removal.
    *   **Wizard Compatibility:** **Problematic.** Similar to `SectionContainer`, the direct import and use of `handleDurationChange` from `sectionsStore` breaks compatibility with `wizardStore`. The component correctly uses an `onRemove` prop, which is good, but duration changes need the same pattern (pass callback via prop) or store refactoring.
*   `src/components/practice-plan/items/ParallelGroup.svelte`:
    *   **Notes:** Renders a container for a parallel group of items. Determines the group's timelines and calculates a display name. Handles drag start for the *entire group* and acts as a drop target for other groups/items. Renders `TimelineColumn` components for each timeline within the group. Provides an "Ungroup" button. Calculates timeline durations.
    *   **Store Interaction:** Imports and uses drag handlers from `dragManager`. Imports and calls `handleUngroup` directly from `sectionsStore`. Imports and uses duration calculation helpers (`calculateTimelineDurations`) and timeline naming functions/stores (`getTimelineName`, `customTimelineNames`) from `sectionsStore`.
    *   **Wizard Compatibility:** **Highly Problematic.** Deeply coupled to `sectionsStore` for ungrouping, duration calculation, and timeline naming. Cannot be used with the wizard's separate state without replicating all this complex logic or refactoring the stores.
*   `src/components/practice-plan/items/TimelineColumn.svelte`:
    *   **Notes:** Renders a single vertical timeline within a `ParallelGroup`. Filters the section's items to display only those belonging to this timeline and group. Acts as a drop target for items being dragged *into* this timeline (`handleTimelineDragOver`, `handleDrop`). Displays the timeline name and total duration. Renders `DrillItem` components for the items within it. Contains complex logic within its `on:drop` handler to manually update `dragState` via `window.__dragManager` before calling the main `handleDrop`.
    *   **Store Interaction:** Imports and uses drag handlers from `dragManager`. Imports `removeItem` and timeline naming helpers (`getTimelineName`, `customTimelineNames`) from `sectionsStore`. Passes the imported `removeItem` down to `DrillItem` via its `onRemove` prop.
    *   **Wizard Compatibility:** **Highly Problematic.** Coupled to `sectionsStore` for item removal and timeline naming. The reliance on `window.__dragManager` in the drop handler is concerning and indicates fragility. Requires significant refactoring for wizard use.

**Overall Conclusion:**

The shared components for displaying and interacting with practice plan sections and items are functional for the main form but suffer from **tight coupling to `sectionsStore` and the complex `dragManager`**. This coupling makes them **unsuitable for direct reuse within the Practice Plan Wizard** as it currently stands with its separate `wizardStore`.

The `dragManager` itself is a major source of complexity and potential fragility. Refactoring the drag-and-drop logic to be less reliant on specific store implementations and potentially simplifying the state tracking could be beneficial.

To enable code sharing and reduce duplication between the main form and the wizard, the primary recommendation remains: **Refactor the state management to use a single source of truth (likely `sectionsStore`, potentially broken down further) for the core plan structure (sections and items), and ensure components receive all necessary data and action callbacks via props rather than importing store functions directly.** This would allow components like `SectionContainer`, `DrillItem`, `ParallelGroup`, and `TimelineColumn` to be truly reusable UI elements, agnostic of whether they are part of the main form or the wizard. 